kind: ConfigMap
apiVersion: v1
metadata:
  name: marketplace-app-create-cm
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
    "helm.sh/hook-weight": "1"
data:
  create.sh: |-
    token=$(curl -iL --request POST 'http://keyrock:8080/v1/auth/tokens' \
      --header 'X-Auth-token: ${token}' \
      --header 'Content-Type: application/json' \
      --data-raw '{
        "name": "${{ .Values.keyrock.admin.email }}",
        "password": "$ADMIN_PASSWORD"
    }'  | awk 'BEGIN {FS=": "}/^x-subject-token/{print $2}' | sed -e 's/\r//')

    echo ++++++++GOT TOKEN
    applicationList=$(curl --location --request GET 'http://keyrock:8080/v1/applications' \
      --header 'X-Auth-token: $token')
    if [[ "$applicationList" == *"\"name\":\"Marketplace\""* ]]; then
      exit 0
    fi 
    echo ++++++++NO APP YET

    appid=$(curl --location --request POST 'http://keyrock:8080/v1/applications' \
      --header 'X-Auth-token: $token' \
      --header 'Content-Type: application/json' \
      --data-raw '{
        "application": {
          "name": "Marketplace",
          "description": "Keyrock client for the marketplace."
          "redirect_uri": "http://marktplatz.ki-marktplatz.fiware.dev/auth/fiware/callback",
          "url": "http://marktplatz.ki-marktplatz.fiware.dev",
          "grant_type": [
            "authorization_code",
            "refresh_token"
          ]
        }
      }' | jq .application.id | sed -e 's/"//' | sed -e 's/"//') 


    echo ++++++++CREATED APP $appid

    curl --location --request POST 'http://keyrock:8080/v1/applications/$appid/roles' \
      --header 'X-Auth-token: $token' \
      --header 'Content-Type: application/json' \
      --data-raw '{
          "role": {
              "name": "admin"
          }
      }'

    curl --location --request POST 'http://keyrock:8080/v1/applications/$appid/roles' \
      --header 'X-Auth-token: $token' \
      --header 'Content-Type: application/json' \
      --data-raw '{
          "role": {
              "name": "orgAdmin"
          }
      }'

    curl --location --request POST 'http://keyrock:8080/v1/applications/$appid/roles' \
      --header 'X-Auth-token: $token' \
      --header 'Content-Type: application/json' \
      --data-raw '{
          "role": {
              "name": "seller"
          }
      }'

    curl --location --request POST 'http://keyrock:8080/v1/applications/$appid/roles' \
      --header 'X-Auth-token: $token' \
      --header 'Content-Type: application/json' \
      --data-raw '{
          "role": {
              "name": "customer"
          }
      }'

      echo ++++++++++++ROLES CREATED